# 识别准确率优化方案

## 问题分析

**原话**："我曾经生活一片狼藉，就像一片茶叶泡在热水"

**识别结果**："💬 我💬 曾💬 是💬 我💬 那个老奸💬 九霞💬 一片💬 叉眼💬 金💬 泡粉💬 如💬 水"

### 主要问题

1. **过度切分**：识别结果被切分成很多短片段（每个字或词单独识别）
2. **准确率低**：很多字识别错误（"生活"→"是"，"狼藉"→"那个老奸"，"茶叶"→"九霞"，"泡在"→"泡粉"）
3. **缺少上下文**：短片段缺少上下文信息，导致识别错误

### 根本原因

1. **VAD静音检测太敏感**：
   - `min_silence_ms=200ms` 太小，导致在说话间隙就切分
   - `initial_silence_ms=500ms` 可能也偏小
   
2. **Local Agreement-n不够严格**：
   - 当前使用 `agreement_n=2`，可能需要更严格（n=3）

3. **音频块太小**：
   - `vac_chunk_size=0.04秒` 可能太小，导致上下文不足

4. **Whisper模型参数**：
   - 可能需要调整 `beam_size` 和 `temperature` 以提高准确性

## 改进方案

### 方案1：调整VAD参数（推荐优先尝试）

**目标**：减少过度切分，让系统等待更完整的句子

**修改**：
- `min_silence_ms`: 200ms → **400-500ms**（增加最小静音时间）
- `initial_silence_ms`: 500ms → **800-1000ms**（增加初始静音时间）
- `max_silence_ms`: 1000ms → **1500-2000ms**（允许更长的静音）

**效果**：系统会等待更长的静音才切分，减少短片段

### 方案2：增加Local Agreement-n

**目标**：提高确认阈值，减少错误识别

**修改**：
- `agreement_n`: 2 → **3**（需要连续3次一致才确认）

**效果**：更准确但延迟稍高

### 方案3：增加音频块大小

**目标**：提供更多上下文信息

**修改**：
- `vac_chunk_size`: 0.04秒 → **0.08-0.1秒**

**效果**：每次处理更多音频，提供更多上下文

### 方案4：调整Whisper模型参数

**目标**：提高识别准确率

**修改**：
- `beam_size`: 5 → **3-5**（保持或降低，提高速度）
- `temperature`: 0.0 → **0.0**（保持，确保确定性）

**注意**：这些参数在 `CustomFasterWhisperASR` 中可能需要调整

### 方案5：组合优化（推荐）

**综合调整**：
1. VAD参数：`min_silence_ms=500`, `initial_silence_ms=1000`, `max_silence_ms=1500`
2. Local Agreement：`agreement_n=3`
3. 音频块：`vac_chunk_size=0.08`
4. 保持其他参数不变

## 配置建议

在 `config.json` 中添加新的配置项：

```json
{
  "asr_optimization": {
    "_comment_vad_min_silence_ms": "最小静音检测时间（毫秒），越大越不容易切分",
    "vad_min_silence_ms": 500,
    "_comment_vad_initial_silence_ms": "初始静音检测时间（毫秒）",
    "vad_initial_silence_ms": 1000,
    "_comment_vad_max_silence_ms": "最大静音检测时间（毫秒）",
    "vad_max_silence_ms": 1500,
    "_comment_agreement_n": "Local Agreement-n的n值（2=平衡，3=更准确）",
    "agreement_n": 3,
    "_comment_vac_chunk_size": "VAC音频块大小（秒），越大上下文越多",
    "vac_chunk_size": 0.08,
    "_comment_beam_size": "Whisper beam_size参数（3-5，越大越准确但越慢）",
    "beam_size": 5,
    "_comment_temperature": "Whisper temperature参数（0.0=确定性，0.2-0.6=创造性）",
    "temperature": 0.0
  }
}
```

## 实施步骤

1. **第一步**：调整VAD参数（最简单，效果最明显）
   - 修改 `min_silence_ms` 和 `initial_silence_ms`
   - 测试效果

2. **第二步**：如果还有问题，增加 `agreement_n`
   - 从2增加到3
   - 测试效果

3. **第三步**：如果还有问题，调整音频块大小
   - 从0.04增加到0.08
   - 测试效果

4. **第四步**：如果还有问题，考虑调整Whisper模型参数
   - 调整 `beam_size` 和 `temperature`

## 预期效果

- ✅ 减少短片段切分（从每个字/词 → 完整句子/半句）
- ✅ 提高识别准确率（从错误很多 → 基本正确）
- ✅ 更好的上下文理解（完整句子 → 更准确的识别）

## 注意事项

1. **延迟增加**：增加静音检测时间和agreement_n会增加延迟
   - 这是准确率和延迟的权衡
   - 建议优先保证准确率

2. **测试环境**：
   - 在安静环境中测试
   - 确保麦克风质量良好
   - 说话清晰、语速适中

3. **逐步调整**：
   - 不要一次性调整所有参数
   - 每次调整一个参数，测试效果
   - 找到最佳平衡点

