# Whisper-Streaming é¡¹ç›®å­¦ä¹ ä¸å€Ÿé‰´æŒ‡å—

## ğŸ“š ç›®å½•
1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
3. [å…³é”®ç®—æ³•è¯¦è§£](#å…³é”®ç®—æ³•è¯¦è§£)
4. [æ ¸å¿ƒç±»ä¸æ¥å£](#æ ¸å¿ƒç±»ä¸æ¥å£)
5. [è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ](#è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ)
6. [å€Ÿé‰´è¦ç‚¹](#å€Ÿé‰´è¦ç‚¹)
7. [æ‰©å±•å»ºè®®](#æ‰©å±•å»ºè®®)

---

## é¡¹ç›®æ¦‚è¿°

### æ ¸å¿ƒé—®é¢˜
Whisper æ¨¡å‹è®¾è®¡ç”¨äºå¤„ç†æœ€å¤š 30 ç§’çš„éŸ³é¢‘å—ï¼Œä½†å®é™…åº”ç”¨éœ€è¦ï¼š
- **å®æ—¶æµå¼å¤„ç†**ï¼šæŒç»­æ¥æ”¶éŸ³é¢‘æµï¼Œä¸èƒ½ç­‰å¾…å®Œæ•´éŸ³é¢‘
- **ä½å»¶è¿Ÿè¾“å‡º**ï¼šå°½å¿«è¾“å‡ºç¨³å®šçš„è½¬å½•ç»“æœ
- **é•¿éŸ³é¢‘æ”¯æŒ**ï¼šå¤„ç†ä»»æ„é•¿åº¦çš„éŸ³é¢‘æµ

### è§£å†³æ–¹æ¡ˆ
é€šè¿‡ **Local Agreement ç­–ç•¥** + **ç¼“å†²åŒºç®¡ç†** + **æ™ºèƒ½è£å‰ª** å®ç°å®æ—¶æµå¼è½¬å½•ã€‚

---

## æ ¸å¿ƒæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
éŸ³é¢‘æµè¾“å…¥
    â†“
[éŸ³é¢‘ç¼“å†²åŒº] â† æŒç»­ç´¯ç§¯éŸ³é¢‘æ•°æ®
    â†“
[Whisper ASR] â† ä½¿ç”¨ init_prompt ä¿æŒä¸Šä¸‹æ–‡
    â†“
[æ—¶é—´æˆ³è¯åˆ—è¡¨] â† [(å¼€å§‹æ—¶é—´, ç»“æŸæ—¶é—´, "å•è¯"), ...]
    â†“
[HypothesisBuffer] â† Local Agreement ç­–ç•¥
    â†“
[ç¡®è®¤çš„è½¬å½•æ–‡æœ¬] â† è¾“å‡ºç»™ç”¨æˆ·
    â†“
[ç¼“å†²åŒºä¿®å‰ª] â† åœ¨å¥å­/æ®µè½è¾¹ç•Œè£å‰ª
```

### æ•°æ®æµ

1. **éŸ³é¢‘è¾“å…¥** â†’ `insert_audio_chunk(audio)`
2. **å¤„ç†è¿­ä»£** â†’ `process_iter()` 
3. **è½¬å½•** â†’ `asr.transcribe(audio_buffer, init_prompt)`
4. **ç¡®è®¤æœºåˆ¶** â†’ `HypothesisBuffer.flush()`
5. **è¾“å‡º** â†’ è¿”å› `(beg_time, end_time, "text")`

---

## å…³é”®ç®—æ³•è¯¦è§£

### 1. Local Agreement ç­–ç•¥ï¼ˆæ ¸å¿ƒç®—æ³•ï¼‰

**åŸç†**ï¼šå¦‚æœè¿ç»­ n æ¬¡æ›´æ–°ï¼ˆæ¯æ¬¡å¤„ç†æ–°çš„éŸ³é¢‘å—ï¼‰å¯¹å‰ç¼€è½¬å½•ç»“æœä¸€è‡´ï¼Œåˆ™ç¡®è®¤è¯¥éƒ¨åˆ†ã€‚

**å®ç°ä½ç½®**ï¼š`HypothesisBuffer` ç±»

#### å…³é”®æ•°æ®ç»“æ„

```python
class HypothesisBuffer:
    def __init__(self):
        self.commited_in_buffer = []  # å·²ç¡®è®¤çš„å•è¯åˆ—è¡¨
        self.buffer = []              # ä¸Šä¸€æ¬¡æ’å…¥çš„å®Œæ•´ç»“æœ
        self.new = []                 # æœ¬æ¬¡æ–°æ’å…¥çš„ç»“æœ
        self.last_commited_time = 0   # æœ€åç¡®è®¤çš„æ—¶é—´æˆ³
```

#### å·¥ä½œæµç¨‹

**æ­¥éª¤ 1ï¼šæ’å…¥æ–°ç»“æœ** (`insert` æ–¹æ³•)
- è¿‡æ»¤æ‰æ—¶é—´æˆ³åœ¨å·²ç¡®è®¤æ—¶é—´ä¹‹å‰çš„è¯
- æ£€æµ‹å¹¶ç§»é™¤ä¸å·²ç¡®è®¤éƒ¨åˆ†é‡å¤çš„ n-gramï¼ˆæœ€å¤š 5 ä¸ªè¯ï¼‰
- å°†æ–°è¯æ·»åŠ åˆ° `self.new`

**æ­¥éª¤ 2ï¼šç¡®è®¤å…¬å…±å‰ç¼€** (`flush` æ–¹æ³•)
- æ¯”è¾ƒ `self.buffer`ï¼ˆä¸Šæ¬¡ç»“æœï¼‰å’Œ `self.new`ï¼ˆæœ¬æ¬¡ç»“æœï¼‰
- æ‰¾åˆ°æœ€é•¿çš„å…¬å…±å‰ç¼€ï¼ˆè¿ç»­ç›¸åŒçš„è¯ï¼‰
- å°†å…¬å…±å‰ç¼€æ ‡è®°ä¸º"å·²ç¡®è®¤"
- æ›´æ–° `self.buffer = self.new`ï¼Œæ¸…ç©º `self.new`

**ç¤ºä¾‹**ï¼š

```
ç¬¬ 1 æ¬¡å¤„ç†: ["Hello", "world", "this", "is"]
ç¬¬ 2 æ¬¡å¤„ç†: ["Hello", "world", "this", "is", "a", "test"]
          â†“
ç¡®è®¤è¾“å‡º: ["Hello", "world", "this", "is"]
ä¿ç•™å¾…ç¡®è®¤: ["a", "test"]
```

### 2. ç¼“å†²åŒºä¿®å‰ªç­–ç•¥

**ç›®çš„**ï¼šé˜²æ­¢éŸ³é¢‘ç¼“å†²åŒºæ— é™å¢é•¿ï¼Œä¿æŒå¤„ç†æ•ˆç‡ã€‚

**ä¸¤ç§ç­–ç•¥**ï¼š

#### ç­–ç•¥ Aï¼šæŒ‰å¥å­ä¿®å‰ª (`sentence`)
- ä½¿ç”¨å¥å­åˆ†å‰²å™¨è¯†åˆ«å®Œæ•´å¥å­
- å½“ç¼“å†²åŒºè¶…è¿‡é˜ˆå€¼æ—¶ï¼Œåœ¨å€’æ•°ç¬¬äºŒä¸ªå®Œæ•´å¥å­å¤„è£å‰ª
- éœ€è¦å®‰è£…è¯­è¨€ç‰¹å®šçš„å¥å­åˆ†å‰²å™¨

#### ç­–ç•¥ Bï¼šæŒ‰æ®µè½ä¿®å‰ª (`segment`) - **æ¨è**
- ä½¿ç”¨ Whisper è¿”å›çš„æ®µè½è¾¹ç•Œ
- å½“ç¼“å†²åŒºè¶…è¿‡é˜ˆå€¼æ—¶ï¼Œåœ¨å€’æ•°ç¬¬äºŒä¸ªæ®µè½ç»“æŸå¤„è£å‰ª
- ä¸éœ€è¦é¢å¤–ä¾èµ–ï¼Œæ€§èƒ½æ›´å¥½

**å®ç°ä½ç½®**ï¼š`OnlineASRProcessor.chunk_completed_segment()`

### 3. Init Prompt æœºåˆ¶

**ç›®çš„**ï¼šä¿æŒä¸Šä¸‹æ–‡è¿ç»­æ€§ï¼Œæé«˜è½¬å½•è´¨é‡ã€‚

**å®ç°**ï¼š
- æå–å·²ç¡®è®¤æ–‡æœ¬çš„æœ€å 200 ä¸ªå­—ç¬¦ä½œä¸º `init_prompt`
- æå–ä»åœ¨ç¼“å†²åŒºå†…çš„å·²ç¡®è®¤æ–‡æœ¬ä½œä¸º `context`ï¼ˆä¼šè¢«é‡æ–°è½¬å½•ä½†è·³è¿‡ï¼‰
- ä¼ é€’ç»™ Whisper çš„ `transcribe()` æ–¹æ³•

**ä»£ç ä½ç½®**ï¼š`OnlineASRProcessor.prompt()`

---

## æ ¸å¿ƒç±»ä¸æ¥å£

### 1. ASRBaseï¼ˆæŠ½è±¡åŸºç±»ï¼‰

**èŒè´£**ï¼šå®šä¹‰æ‰€æœ‰ ASR åç«¯çš„ç»Ÿä¸€æ¥å£

**å…³é”®æ–¹æ³•**ï¼š
```python
class ASRBase:
    def load_model(self, modelsize, cache_dir, model_dir)
    def transcribe(self, audio, init_prompt="")
    def ts_words(self, result)  # æå–æ—¶é—´æˆ³è¯åˆ—è¡¨
    def segments_end_ts(self, result)  # æå–æ®µè½ç»“æŸæ—¶é—´æˆ³
    def use_vad(self)  # å¯ç”¨è¯­éŸ³æ´»åŠ¨æ£€æµ‹
    def set_translate_task()  # è®¾ç½®ä¸ºç¿»è¯‘ä»»åŠ¡
```

**è®¾è®¡æ¨¡å¼**ï¼šç­–ç•¥æ¨¡å¼ - ä¸åŒåç«¯å®ç°ç›¸åŒæ¥å£

### 2. OnlineASRProcessorï¼ˆæ ¸å¿ƒå¤„ç†ç±»ï¼‰

**èŒè´£**ï¼šç®¡ç†éŸ³é¢‘ç¼“å†²åŒºï¼Œåè°ƒè½¬å½•å’Œç¡®è®¤æµç¨‹

**å…³é”®æ–¹æ³•**ï¼š

#### `__init__(asr, tokenizer, buffer_trimming, logfile)`
- åˆå§‹åŒ–éŸ³é¢‘ç¼“å†²åŒºå’Œè½¬å½•ç¼“å†²åŒº
- è®¾ç½®ç¼“å†²åŒºä¿®å‰ªç­–ç•¥

#### `insert_audio_chunk(audio)`
- å°†æ–°éŸ³é¢‘è¿½åŠ åˆ°ç¼“å†²åŒº

#### `process_iter()` - **æ ¸å¿ƒæ–¹æ³•**
```python
def process_iter(self):
    # 1. ç”Ÿæˆ prompt å’Œ context
    prompt, non_prompt = self.prompt()
    
    # 2. è½¬å½•å½“å‰ç¼“å†²åŒº
    res = self.asr.transcribe(self.audio_buffer, init_prompt=prompt)
    
    # 3. æå–æ—¶é—´æˆ³è¯
    tsw = self.asr.ts_words(res)
    
    # 4. æ’å…¥åˆ° HypothesisBuffer
    self.transcript_buffer.insert(tsw, self.buffer_time_offset)
    
    # 5. è·å–ç¡®è®¤çš„æ–‡æœ¬ï¼ˆLocal Agreementï¼‰
    o = self.transcript_buffer.flush()
    
    # 6. æ›´æ–°å·²ç¡®è®¤åˆ—è¡¨
    self.commited.extend(o)
    
    # 7. æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿®å‰ªç¼“å†²åŒº
    if len(self.audio_buffer) > threshold:
        self.chunk_completed_segment(res)
    
    # 8. è¿”å›ç¡®è®¤çš„æ–‡æœ¬
    return self.to_flush(o)
```

#### `chunk_at(time)`
- åœ¨æŒ‡å®šæ—¶é—´ç‚¹è£å‰ªéŸ³é¢‘ç¼“å†²åŒºå’Œè½¬å½•ç¼“å†²åŒº
- æ›´æ–° `buffer_time_offset`

### 3. HypothesisBufferï¼ˆç¡®è®¤ç¼“å†²åŒºï¼‰

**èŒè´£**ï¼šå®ç° Local Agreement ç­–ç•¥

**å…³é”®æ–¹æ³•**ï¼š

#### `insert(new, offset)`
- æ’å…¥æ–°çš„è½¬å½•ç»“æœ
- ç§»é™¤ä¸å·²ç¡®è®¤éƒ¨åˆ†é‡å¤çš„ n-gram
- åªä¿ç•™æ—¶é—´æˆ³åœ¨ `last_commited_time` ä¹‹åçš„è¯

#### `flush()`
- è¿”å›ä¸¤æ¬¡æ’å…¥çš„æœ€é•¿å…¬å…±å‰ç¼€ï¼ˆLocal Agreement-2ï¼‰
- æ›´æ–°å·²ç¡®è®¤çŠ¶æ€

#### `pop_commited(time)`
- ç§»é™¤æ—¶é—´æˆ³å°äºç­‰äº `time` çš„å·²ç¡®è®¤è¯
- ç”¨äºç¼“å†²åŒºä¿®å‰ªæ—¶æ¸…ç†æ—§æ•°æ®

### 4. VACOnlineASRProcessorï¼ˆVAD åŒ…è£…å™¨ï¼‰

**èŒè´£**ï¼šåœ¨ OnlineASRProcessor åŸºç¡€ä¸Šæ·»åŠ è¯­éŸ³æ´»åŠ¨æ£€æµ‹

**å·¥ä½œæµç¨‹**ï¼š
1. ä½¿ç”¨ Silero VAD æ£€æµ‹è¯­éŸ³æ´»åŠ¨
2. æ£€æµ‹åˆ°è¯­éŸ³å¼€å§‹æ—¶ï¼Œåˆå§‹åŒ– OnlineASRProcessor
3. æ£€æµ‹åˆ°é™éŸ³ 500ms åï¼Œæ ‡è®°ä¸ºæœ€ç»ˆè¾“å‡º
4. åªåœ¨æœ‰è¯­éŸ³æ—¶å¤„ç†éŸ³é¢‘ï¼ŒèŠ‚çœè®¡ç®—èµ„æº

---

## è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ

### 1. ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰

**åº”ç”¨**ï¼šå¤šç§ ASR åç«¯
- `FasterWhisperASR`
- `WhisperTimestampedASR`
- `MLXWhisper`
- `OpenaiApiASR`

æ‰€æœ‰åç«¯å®ç° `ASRBase` æ¥å£ï¼Œå¯ä»¥æ— ç¼åˆ‡æ¢ã€‚

**å€Ÿé‰´è¦ç‚¹**ï¼š
- å®šä¹‰æ¸…æ™°çš„æŠ½è±¡æ¥å£
- æ¯ä¸ªå®ç°ç±»ç‹¬ç«‹å°è£…
- ä½¿ç”¨å·¥å‚å‡½æ•°åˆ›å»ºå®ä¾‹

### 2. æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼ˆTemplate Methodï¼‰

**åº”ç”¨**ï¼š`OnlineASRProcessor.process_iter()`
- å®šä¹‰äº†å›ºå®šçš„å¤„ç†æµç¨‹
- å…·ä½“æ­¥éª¤å¯ä»¥è¢«å­ç±»é‡å†™ï¼ˆå¦‚ `VACOnlineASRProcessor`ï¼‰

### 3. ç¼“å†²åŒºç®¡ç†æœ€ä½³å®è·µ

**è¦ç‚¹**ï¼š
- ä½¿ç”¨æ—¶é—´æˆ³è€Œéå›ºå®šå¤§å°ç®¡ç†ç¼“å†²åŒº
- åœ¨è¯­ä¹‰è¾¹ç•Œï¼ˆå¥å­/æ®µè½ï¼‰å¤„è£å‰ªï¼Œè€Œéä»»æ„ä½ç½®
- ä¿æŒå·²ç¡®è®¤æ–‡æœ¬çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆinit_promptï¼‰

### 4. é”™è¯¯å¤„ç†

**è¦ç‚¹**ï¼š
- å¤„ç†æ—¶é—´æˆ³ä¸å‡†ç¡®çš„æƒ…å†µï¼ˆå…è®¸ 0.1 ç§’è¯¯å·®ï¼‰
- å¤„ç†é‡å¤çš„ n-gramï¼ˆæœ€å¤š 5 ä¸ªè¯ï¼‰
- å¤„ç†ç©ºç»“æœå’Œè¾¹ç•Œæƒ…å†µ

---

## å€Ÿé‰´è¦ç‚¹

### 1. å¦‚ä½•å®ç°æµå¼å¤„ç†

**æ ¸å¿ƒæ€è·¯**ï¼š
```python
# ä¼ªä»£ç 
while æœ‰éŸ³é¢‘è¾“å…¥:
    1. æ¥æ”¶éŸ³é¢‘å— â†’ insert_audio_chunk()
    2. å¤„ç†ç¼“å†²åŒº â†’ process_iter()
    3. è¾“å‡ºç¡®è®¤çš„æ–‡æœ¬
    4. ä¿®å‰ªç¼“å†²åŒºï¼ˆå¦‚éœ€è¦ï¼‰
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨æ»‘åŠ¨çª—å£è€Œéå›ºå®šçª—å£
- åœ¨è¯­ä¹‰è¾¹ç•Œå¤„è£å‰ª
- ä¿æŒä¸Šä¸‹æ–‡è¿ç»­æ€§

### 2. å¦‚ä½•å®ç°ä½å»¶è¿Ÿç¡®è®¤

**æ ¸å¿ƒæ€è·¯**ï¼šLocal Agreement ç­–ç•¥
- æ¯”è¾ƒè¿ç»­ä¸¤æ¬¡å¤„ç†ç»“æœ
- ç¡®è®¤å…¬å…±å‰ç¼€
- ç«‹å³è¾“å‡ºç¡®è®¤éƒ¨åˆ†

**å‚æ•°è°ƒä¼˜**ï¼š
- å¯ä»¥æ”¹ä¸º Local Agreement-nï¼ˆn > 2ï¼‰æé«˜å‡†ç¡®æ€§ï¼Œä½†ä¼šå¢åŠ å»¶è¿Ÿ
- å½“å‰å®ç°æ˜¯ n=2ï¼Œå¹³è¡¡äº†å»¶è¿Ÿå’Œå‡†ç¡®æ€§

### 3. å¦‚ä½•ç®¡ç†é•¿éŸ³é¢‘

**æ ¸å¿ƒæ€è·¯**ï¼šæ™ºèƒ½ç¼“å†²åŒºä¿®å‰ª
- ç›‘æ§ç¼“å†²åŒºé•¿åº¦
- åœ¨å®Œæ•´å¥å­/æ®µè½è¾¹ç•Œå¤„è£å‰ª
- ä¿ç•™è£å‰ªå‰çš„ä¸Šä¸‹æ–‡ä½œä¸º prompt

### 4. å¦‚ä½•ä¿æŒä¸Šä¸‹æ–‡

**æ ¸å¿ƒæ€è·¯**ï¼šInit Prompt æœºåˆ¶
- æå–å·²ç¡®è®¤æ–‡æœ¬çš„åç¼€ï¼ˆ200 å­—ç¬¦ï¼‰
- ä½œä¸ºä¸‹æ¬¡è½¬å½•çš„åˆå§‹æç¤º
- å¸®åŠ©æ¨¡å‹ç†è§£ä¸Šä¸‹æ–‡

### 5. å¦‚ä½•é€‚é…ä¸åŒåç«¯

**æ ¸å¿ƒæ€è·¯**ï¼šç»Ÿä¸€æ¥å£ + å·¥å‚æ¨¡å¼
```python
# å®šä¹‰æ¥å£
class ASRBase:
    def transcribe(self, audio, init_prompt): ...
    def ts_words(self, result): ...

# å®ç°ä¸åŒåç«¯
class FasterWhisperASR(ASRBase): ...
class OpenaiApiASR(ASRBase): ...

# å·¥å‚å‡½æ•°
def asr_factory(args):
    if args.backend == "faster-whisper":
        return FasterWhisperASR(...)
    elif args.backend == "openai-api":
        return OpenaiApiASR(...)
```

---

## æ‰©å±•å»ºè®®

### 1. æ·»åŠ æ–°çš„ ASR åç«¯

**æ­¥éª¤**ï¼š
1. ç»§æ‰¿ `ASRBase` ç±»
2. å®ç°æ‰€æœ‰æŠ½è±¡æ–¹æ³•
3. åœ¨ `asr_factory()` ä¸­æ·»åŠ åˆ›å»ºé€»è¾‘

**ç¤ºä¾‹**ï¼š
```python
class CustomASR(ASRBase):
    def load_model(self, modelsize, cache_dir, model_dir):
        # åŠ è½½ä½ çš„æ¨¡å‹
        pass
    
    def transcribe(self, audio, init_prompt=""):
        # è°ƒç”¨ä½ çš„æ¨¡å‹è¿›è¡Œè½¬å½•
        # è¿”å›åŒ…å«æ—¶é—´æˆ³çš„ç»“æœ
        pass
    
    def ts_words(self, result):
        # ä»ç»“æœä¸­æå– [(start, end, word), ...]
        pass
    
    def segments_end_ts(self, result):
        # ä»ç»“æœä¸­æå–æ®µè½ç»“æŸæ—¶é—´æˆ³åˆ—è¡¨
        pass
```

### 2. è‡ªå®šä¹‰ç¡®è®¤ç­–ç•¥

**å½“å‰**ï¼šLocal Agreement-2ï¼ˆè¿ç»­ 2 æ¬¡ä¸€è‡´ï¼‰

**æ‰©å±•**ï¼š
- Local Agreement-nï¼šè¿ç»­ n æ¬¡ä¸€è‡´æ‰ç¡®è®¤
- ç½®ä¿¡åº¦é˜ˆå€¼ï¼šåªæœ‰ç½®ä¿¡åº¦é«˜äºé˜ˆå€¼æ‰ç¡®è®¤
- æ—¶é—´çª—å£ï¼šåœ¨æ—¶é—´çª—å£å†…ä¸€è‡´æ‰ç¡®è®¤

**ä¿®æ”¹ä½ç½®**ï¼š`HypothesisBuffer.flush()` æ–¹æ³•

### 3. æ·»åŠ å®æ—¶å¯è§†åŒ–

**æ€è·¯**ï¼š
- ä½¿ç”¨ WebSocket æ¨é€éƒ¨åˆ†ç»“æœ
- å‰ç«¯å®æ—¶æ˜¾ç¤ºç¡®è®¤æ–‡æœ¬å’Œå¾…ç¡®è®¤æ–‡æœ¬
- æ˜¾ç¤ºå»¶è¿ŸæŒ‡æ ‡

### 4. ä¼˜åŒ–å»¶è¿Ÿ

**æ–¹æ³•**ï¼š
- ä½¿ç”¨æ›´å°çš„ `min_chunk_size`
- ä½¿ç”¨æ›´å¿«çš„ ASR åç«¯ï¼ˆå¦‚ faster-whisperï¼‰
- ä½¿ç”¨ GPU åŠ é€Ÿ
- ä¼˜åŒ–ç¼“å†²åŒºä¿®å‰ªç­–ç•¥

### 5. æ·»åŠ å¤šè¯­è¨€æ”¯æŒå¢å¼º

**å½“å‰**ï¼šæ”¯æŒ Whisper çš„æ‰€æœ‰è¯­è¨€

**æ‰©å±•**ï¼š
- è‡ªåŠ¨è¯­è¨€æ£€æµ‹ä¼˜åŒ–
- è¯­è¨€ç‰¹å®šçš„å¥å­åˆ†å‰²å™¨
- è¯­è¨€ç‰¹å®šçš„ç¼“å†²åŒºä¿®å‰ªç­–ç•¥

### 6. æ·»åŠ é”™è¯¯æ¢å¤æœºåˆ¶

**æ€è·¯**ï¼š
- æ£€æµ‹å¼‚å¸¸ç»“æœï¼ˆå¦‚æ—¶é—´æˆ³å€’åºï¼‰
- è‡ªåŠ¨å›é€€åˆ°ä¸Šä¸€ä¸ªç¨³å®šçŠ¶æ€
- è®°å½•é”™è¯¯æ—¥å¿—ç”¨äºè°ƒè¯•

---

## ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šåŸºæœ¬ä½¿ç”¨

```python
from whisper_online import FasterWhisperASR, OnlineASRProcessor

# 1. åˆ›å»º ASR å®ä¾‹
asr = FasterWhisperASR(lan="zh", modelsize="large-v2")

# 2. åˆ›å»ºåœ¨çº¿å¤„ç†å™¨
online = OnlineASRProcessor(
    asr=asr,
    tokenizer=None,  # ä½¿ç”¨ segment ä¿®å‰ªç­–ç•¥æ—¶ä¸éœ€è¦
    buffer_trimming=("segment", 15)  # 15ç§’é˜ˆå€¼
)

# 3. å¤„ç†éŸ³é¢‘æµ
audio_chunks = [...]  # ä½ çš„éŸ³é¢‘å—åˆ—è¡¨

for chunk in audio_chunks:
    # æ’å…¥éŸ³é¢‘
    online.insert_audio_chunk(chunk)
    
    # å¤„ç†å¹¶è·å–ç»“æœ
    result = online.process_iter()
    
    if result[0] is not None:  # æœ‰ç¡®è®¤çš„æ–‡æœ¬
        beg_time, end_time, text = result
        print(f"[{beg_time:.2f}s-{end_time:.2f}s] {text}")

# 4. å¤„ç†æœ€åçš„ä¸å®Œæ•´éƒ¨åˆ†
final_result = online.finish()
if final_result[0] is not None:
    print(f"æœ€ç»ˆ: {final_result[2]}")
```

### ç¤ºä¾‹ 2ï¼šä½¿ç”¨ VACï¼ˆè¯­éŸ³æ´»åŠ¨æ£€æµ‹ï¼‰

```python
from whisper_online import FasterWhisperASR, VACOnlineASRProcessor

asr = FasterWhisperASR(lan="en", modelsize="base")

# VAC ä¼šè‡ªåŠ¨æ£€æµ‹è¯­éŸ³æ´»åŠ¨
online = VACOnlineASRProcessor(
    online_chunk_size=0.04,  # 40ms éŸ³é¢‘å—
    asr=asr,
    buffer_trimming=("segment", 15)
)

# å¤„ç†æµç¨‹ç›¸åŒ
for chunk in audio_chunks:
    online.insert_audio_chunk(chunk)
    result = online.process_iter()
    if result[0] is not None:
        print(result[2])
```

### ç¤ºä¾‹ 3ï¼šè‡ªå®šä¹‰åç«¯

```python
from whisper_online import ASRBase

class MyCustomASR(ASRBase):
    sep = " "  # å•è¯åˆ†éš”ç¬¦
    
    def load_model(self, modelsize, cache_dir, model_dir):
        # åŠ è½½ä½ çš„æ¨¡å‹
        self.model = load_my_model(modelsize)
        return self.model
    
    def transcribe(self, audio, init_prompt=""):
        # è°ƒç”¨ä½ çš„æ¨¡å‹
        result = self.model.transcribe(
            audio, 
            initial_prompt=init_prompt,
            language=self.original_language
        )
        return result
    
    def ts_words(self, result):
        # æå–æ—¶é—´æˆ³è¯åˆ—è¡¨
        words = []
        for segment in result["segments"]:
            for word in segment["words"]:
                words.append((word["start"], word["end"], word["text"]))
        return words
    
    def segments_end_ts(self, result):
        return [s["end"] for s in result["segments"]]
    
    def use_vad(self):
        # å¦‚æœæ”¯æŒ VADï¼Œåœ¨è¿™é‡Œå¯ç”¨
        pass
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ¨¡å‹é€‰æ‹©
- **é€Ÿåº¦ä¼˜å…ˆ**ï¼š`tiny` æˆ– `base`
- **è´¨é‡ä¼˜å…ˆ**ï¼š`large-v2` æˆ– `large-v3`
- **å¹³è¡¡**ï¼š`small` æˆ– `medium`

### 2. åç«¯é€‰æ‹©
- **GPU å¯ç”¨**ï¼š`faster-whisper`ï¼ˆæœ€å¿«ï¼‰
- **Apple Silicon**ï¼š`mlx-whisper`ï¼ˆä¼˜åŒ–ï¼‰
- **æ—  GPU**ï¼š`whisper_timestamped` æˆ– `openai-api`

### 3. å‚æ•°è°ƒä¼˜
- `min_chunk_size`ï¼šè¶Šå°å»¶è¿Ÿè¶Šä½ï¼Œä½†è®¡ç®—å¼€é”€è¶Šå¤§
- `buffer_trimming_sec`ï¼šè¶Šå°å†…å­˜å ç”¨è¶Šå°‘ï¼Œä½†å¯èƒ½å½±å“è´¨é‡
- VACï¼šå¯ä»¥æ˜¾è‘—å‡å°‘éè¯­éŸ³æ—¶çš„è®¡ç®—

### 4. ç¡¬ä»¶ä¼˜åŒ–
- ä½¿ç”¨ GPU åŠ é€Ÿï¼ˆCUDAï¼‰
- ä½¿ç”¨é‡åŒ–æ¨¡å‹ï¼ˆINT8ï¼‰å‡å°‘å†…å­˜
- æ‰¹é‡å¤„ç†å¤šä¸ªéŸ³é¢‘æµ

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆå»¶è¿Ÿè¿˜æ˜¯å¾ˆé«˜ï¼Ÿ
**A**: 
- æ£€æŸ¥ `min_chunk_size` æ˜¯å¦å¤ªå¤§
- æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº† GPU
- æ£€æŸ¥æ¨¡å‹å¤§å°ï¼ˆå¤§æ¨¡å‹æ›´æ…¢ï¼‰
- è€ƒè™‘ä½¿ç”¨ VAC å‡å°‘éè¯­éŸ³å¤„ç†

### Q2: å¦‚ä½•æé«˜è½¬å½•è´¨é‡ï¼Ÿ
**A**:
- ä½¿ç”¨æ›´å¤§çš„æ¨¡å‹
- æä¾›å‡†ç¡®çš„ `init_prompt`
- ä½¿ç”¨ VAD è¿‡æ»¤éè¯­éŸ³éƒ¨åˆ†
- è°ƒæ•´ `buffer_trimming_sec` ç»™æ¨¡å‹æ›´å¤šä¸Šä¸‹æ–‡

### Q3: å¦‚ä½•å¤„ç†å¤šè¯´è¯äººï¼Ÿ
**A**:
- å½“å‰ç‰ˆæœ¬ä¸æ”¯æŒè¯´è¯äººåˆ†ç¦»
- å¯ä»¥å…ˆç”¨è¯´è¯äººåˆ†ç¦»å·¥å…·é¢„å¤„ç†éŸ³é¢‘
- æˆ–è€…ç­‰å¾…æœªæ¥ç‰ˆæœ¬æ”¯æŒ

### Q4: å¦‚ä½•é›†æˆåˆ°æˆ‘çš„åº”ç”¨ï¼Ÿ
**A**:
- ä½œä¸ºæ¨¡å—å¯¼å…¥ï¼š`from whisper_online import *`
- ä½¿ç”¨ `OnlineASRProcessor` ç±»
- å®ç°éŸ³é¢‘è¾“å…¥æ¥å£ï¼ˆéº¦å…‹é£ã€æ–‡ä»¶ã€ç½‘ç»œæµç­‰ï¼‰
- å®ç°è¾“å‡ºæ¥å£ï¼ˆæ˜¾ç¤ºã€ä¿å­˜ã€API ç­‰ï¼‰

---

## å‚è€ƒèµ„æ–™

- **è®ºæ–‡**ï¼š[Turning Whisper into Real-Time Transcription System](https://aclanthology.org/2023.ijcnlp-demo.3/)
- **GitHub**ï¼šhttps://github.com/ufal/whisper_streaming
- **æ¼”ç¤ºè§†é¢‘**ï¼šhttps://player.vimeo.com/video/840442741
- **æ–°é¡¹ç›®**ï¼šhttps://github.com/ufal/SimulStreamingï¼ˆ2025å¹´æ¨èï¼‰

---

## æ€»ç»“

Whisper-Streaming çš„æ ¸å¿ƒåˆ›æ–°åœ¨äºï¼š

1. **Local Agreement ç­–ç•¥**ï¼šé€šè¿‡æ¯”è¾ƒè¿ç»­å¤„ç†ç»“æœç¡®è®¤ç¨³å®šè¾“å‡º
2. **æ™ºèƒ½ç¼“å†²åŒºç®¡ç†**ï¼šåœ¨è¯­ä¹‰è¾¹ç•Œå¤„è£å‰ªï¼Œä¿æŒä¸Šä¸‹æ–‡
3. **ç»Ÿä¸€æ¥å£è®¾è®¡**ï¼šæ”¯æŒå¤šç§åç«¯ï¼Œæ˜“äºæ‰©å±•
4. **Init Prompt æœºåˆ¶**ï¼šä¿æŒä¸Šä¸‹æ–‡è¿ç»­æ€§

è¿™äº›è®¾è®¡æ€è·¯å¯ä»¥åº”ç”¨åˆ°å…¶ä»–æµå¼å¤„ç†ä»»åŠ¡ä¸­ï¼Œå¦‚ï¼š
- å®æ—¶ç¿»è¯‘
- å®æ—¶è¯­éŸ³è¯†åˆ«
- å®æ—¶å­—å¹•ç”Ÿæˆ
- å®æ—¶è¯­éŸ³åˆ†æ

å¸Œæœ›è¿™ä»½æŒ‡å—èƒ½å¸®åŠ©ä½ ç†è§£å’Œå€Ÿé‰´è¿™ä¸ªé¡¹ç›®çš„è®¾è®¡æ€æƒ³ï¼

