# 人声分离使用说明

## 一、功能概述

人声分离功能可以从音频中分离人声和背景音乐，提高在有背景音乐环境下的语音识别准确率。

## 二、支持的方案

### 1. Demucs（推荐）⭐

**优点**：
- ✅ 高质量分离
- ✅ 支持实时处理
- ✅ 有轻量级模型（htdemucs）
- ✅ 支持GPU加速

**缺点**：
- ⚠️ 需要安装额外依赖
- ⚠️ 轻量级模型仍有计算开销

**安装**：
```bash
pip install demucs
```

**模型选择**：
- `htdemucs`：轻量级，适合实时（推荐）
- `htdemucs_ft`：更高质量但更慢
- `mdx`：最高质量但最慢（不推荐实时）

**路径说明**：
-  留空或空字符串：使用 Demucs 默认路径
-  Windows: C:\Users\<用户名>\.cache\torch\hub\checkpoints\
-  Linux/macOS: ~/.cache/torch/hub/checkpoints/
-  指定路径：使用自定义路径
-  绝对路径：D:/whisper/models/demucs
-  相对路径：./.../demucs
-  路径不存在时会自动创建
**Demucs 官方文档**: https://github.com/facebookresearch/demucs
**默认路径**: 查看 `demucs.pretrained.get_model()` 文档

### 2. Spleeter

**优点**：
- ✅ 成熟稳定
- ✅ 预训练模型质量好

**缺点**：
- ⚠️ 主要用于离线处理
- ⚠️ 实时性能较差
- ⚠️ 需要下载模型（首次运行较慢）

**安装**：
```bash
pip install spleeter
```

**模型选择**：
- `2stems`：人声+伴奏（推荐，最快）
- `4stems`：人声、鼓、贝斯、其他
- `5stems`：人声、鼓、贝斯、钢琴、其他

### 3. 简单频域滤波

**优点**：
- ✅ 无需额外依赖（只需scipy）
- ✅ 实时性能好
- ✅ 计算开销小

**缺点**：
- ⚠️ 效果有限
- ⚠️ 可能误过滤人声
- ⚠️ 只适合简单场景

**安装**：
```bash
pip install scipy
```

**原理**：
- 人声主要在 85-255 Hz（基频）和 300-3400 Hz（共振峰）
- 使用带通滤波器保留人声频段

## 三、配置方法

在 `config.json` 中配置：

```json
{
  "vocal_separation": {
    "enable": true,  // 是否启用
    "method": "demucs",  // 分离方法：demucs, spleeter, filter, none
    "demucs_model": "htdemucs",  // Demucs模型（如果使用demucs）
    "spleeter_model": "2stems",  // Spleeter模型（如果使用spleeter）
    "filter_low_cut": 85.0,  // 频域滤波低截止频率（如果使用filter）
    "filter_high_cut": 3400.0  // 频域滤波高截止频率（如果使用filter）
  }
}
```

## 四、使用建议

### 场景1：有背景音乐，需要高质量分离

**推荐配置**：
```json
{
  "vocal_separation": {
    "enable": true,
    "method": "demucs",
    "demucs_model": "htdemucs"
  }
}
```

**安装**：
```bash
pip install demucs
```

### 场景2：背景音乐简单，需要快速处理

**推荐配置**：
```json
{
  "vocal_separation": {
    "enable": true,
    "method": "filter",
    "filter_low_cut": 85.0,
    "filter_high_cut": 3400.0
  }
}
```

**安装**：
```bash
pip install scipy
```

### 场景3：不需要人声分离

**推荐配置**：
```json
{
  "vocal_separation": {
    "enable": false
  }
}
```

或者：
```json
{
  "vocal_separation": {
    "enable": true,
    "method": "none"
  }
}
```

## 五、性能影响

### Demucs (htdemucs)
- **CPU模式**：增加延迟约 50-100ms
- **GPU模式**：增加延迟约 10-30ms
- **内存占用**：约 200-500MB

### Spleeter (2stems)
- **延迟**：增加延迟约 200-500ms（不推荐实时）
- **内存占用**：约 500MB-1GB

### 简单滤波
- **延迟**：增加延迟约 1-5ms（几乎可忽略）
- **内存占用**：几乎无额外占用

## 六、注意事项

1. **首次使用**：
   - Demucs 和 Spleeter 首次运行会下载模型，需要网络连接
   - 模型文件较大（几百MB到几GB），需要足够的磁盘空间

2. **GPU加速**：
   - Demucs 支持GPU加速，如果有NVIDIA GPU会自动使用
   - GPU模式下性能更好，延迟更低

3. **实时性**：
   - Demucs (htdemucs) 适合实时场景
   - Spleeter 主要用于离线处理，实时性能较差
   - 简单滤波实时性能最好，但效果有限

4. **效果评估**：
   - 不同音频效果可能不同
   - 建议先测试，根据实际情况选择方案
   - 如果背景音乐太复杂，可能需要提高VAD阈值配合使用

## 七、故障排除

### 问题1：提示"Demucs 未安装"

**解决**：
```bash
pip install demucs
```

### 问题2：提示"Spleeter 未安装"

**解决**：
```bash
pip install spleeter
```

### 问题3：提示"scipy 未安装"（使用filter时）

**解决**：
```bash
pip install scipy
```

### 问题4：分离效果不好

**解决**：
1. 尝试使用 Demucs (htdemucs_ft) 或更高模型
2. 提高 VAD 阈值（`asr_optimization.vad_threshold`）
3. 结合使用跳句检测器过滤重复结果

### 问题5：延迟太高

**解决**：
1. 使用简单滤波（filter）方法
2. 如果有GPU，确保使用GPU模式
3. 如果不需要高质量，可以关闭人声分离，只提高VAD阈值

## 八、参考链接

- **Demucs**: https://github.com/facebookresearch/demucs
- **Spleeter**: https://github.com/deezer/spleeter
- **项目文档**: 查看 `vocal_separation.py` 源码

