# 新功能使用说明

## 一、配置管理

### 1.1 配置文件

项目现在支持通过 `config.json` 文件集中管理所有配置参数。

**配置文件位置**：`config.json`

**首次运行**：如果配置文件不存在，程序会自动创建默认配置文件。

### 1.2 配置项说明

#### 跳句检测器配置 (`skip_detector`)

```json
{
  "similarity_threshold": 0.85,  // 相似度阈值（0-1），超过此值认为是重复
  "time_window": 3.0,            // 时间窗口（秒），只在此时间窗口内进行去重
  "min_length": 2,               // 最小文本长度，短于此长度的文本不进行去重
  "use_edit_distance": true       // 是否使用编辑距离算法（更准确但稍慢）
}
```

#### 设备保护器配置 (`device_protector`)

```json
{
  "max_retries": 3,      // 最大重试次数
  "retry_delay": 1.0,    // 重试延迟（秒）
  "check_interval": 0.5   // 设备检查间隔（秒）
}
```

#### 音频配置 (`audio`)

```json
{
  "sampling_rate": 16000,  // 采样率（Hz）
  "channels": 1,            // 声道数
  "blocksize": 512          // 块大小
}
```

#### 性能监控配置 (`performance_monitor`)

```json
{
  "enable": true,              // 是否启用性能监控
  "update_interval": 5.0,      // 更新间隔（秒）
  "show_stats": true,          // 是否显示统计信息
  "show_device_status": true   // 是否显示设备状态
}
```

#### UI配置 (`ui`)

```json
{
  "show_colors": true,        // 是否使用彩色输出
  "show_progress": true,      // 是否显示进度
  "verbose_errors": true      // 是否显示详细错误信息
}
```

#### 日志配置 (`logging`)

```json
{
  "skip_log_enabled": true,           // 是否启用跳句日志
  "performance_log_enabled": true,    // 是否启用性能日志
  "device_log_enabled": true          // 是否启用设备日志
}
```

### 1.3 修改配置

1. **直接编辑配置文件**：
   - 打开 `config.json` 文件
   - 修改相应的配置值
   - 保存文件
   - 下次运行程序时自动加载新配置

2. **程序运行时修改**（未来功能）：
   - 可以通过程序接口动态修改配置
   - 修改后自动保存到配置文件

### 1.4 配置验证

程序会自动验证配置值的有效性：
- 相似度阈值必须在 0-1 之间
- 时间窗口必须大于等于 0
- 最小文本长度必须大于等于 1
- 采样率必须在合理范围内（8000-48000）
- 等等...

如果配置值无效，程序会使用默认值并显示警告。

## 二、性能监控和实时显示

### 2.1 实时统计信息

程序运行时会实时显示以下统计信息：

- **运行时间**：程序运行的总时长
- **识别检查次数**：总共检查的识别结果数
- **跳过次数和跳过率**：跳过的识别结果数和百分比
- **详细统计**：
  - 完全重复次数
  - 部分重复次数
  - 相似文本次数
- **设备状态**：
  - 设备名称
  - 设备健康状态（正常/警告/断开）
  - 设备恢复次数

### 2.2 显示位置

统计信息显示在控制台底部，每 5 秒更新一次（可配置）。

**示例显示**：
```
📊 运行时间: 5分30秒 | 识别检查: 100 次 | 跳过: 18 次 (18.0%) | 设备状态: 正常 (麦克风名称)
  └─ 完全重复: 10, 部分重复: 5, 相似文本: 3
```

### 2.3 配置性能监控

在 `config.json` 中配置：

```json
{
  "performance_monitor": {
    "enable": true,              // 是否启用
    "update_interval": 5.0,      // 更新间隔（秒）
    "show_stats": true,          // 是否显示统计
    "show_device_status": true   // 是否显示设备状态
  }
}
```

### 2.4 禁用性能监控

如果不想显示性能统计，可以设置：

```json
{
  "performance_monitor": {
    "enable": false
  }
}
```

## 三、用户体验改进

### 3.1 友好的错误提示

程序现在提供更友好的错误提示，包括：

- **错误类型**：明确标识错误类型
- **错误消息**：详细的错误描述
- **建议**：针对性的解决建议

**示例**：
```
✗ 错误: 设备打开失败
  无法打开音频流: 设备被占用
  💡 建议: 请检查麦克风是否已连接并启用，或是否被其他程序占用
```

### 3.2 状态显示

程序会显示各种状态信息：

- **成功信息**（绿色）：
  ```
  ✓ 成功: 麦克风已就绪（设备保护已启用）
  ```

- **警告信息**（黄色）：
  ```
  ⚠ 警告: 音频缓冲区溢出
  ```

- **信息提示**（青色）：
  ```
  ℹ 信息: 继续录音中...
  ```

- **进度提示**：
  ```
  ⏳ 正在打开麦克风...
  ```

### 3.3 彩色输出

程序支持彩色输出（在支持颜色的终端中）：
- 绿色：成功、正常状态
- 黄色：警告、需要注意
- 红色：错误、异常状态
- 青色：信息、提示
- 等等...

**禁用彩色输出**：
在 `config.json` 中设置：
```json
{
  "ui": {
    "show_colors": false
  }
}
```

### 3.4 设备状态显示

程序会实时显示设备状态：
- **正常**（绿色）：设备工作正常
- **警告**（黄色）：设备可能有问题
- **断开**（红色）：设备已断开

## 四、单元测试

### 4.1 运行测试

运行单元测试验证功能：

```bash
python test_improvements.py
```

### 4.2 测试内容

测试包括以下内容：

1. **跳句检测器测试**：
   - 完全重复检测
   - 部分重复检测
   - 相似度检测
   - 时间窗口机制
   - 最小文本长度
   - 统计信息
   - 重置功能

2. **配置管理器测试**：
   - 默认配置
   - 加载和保存配置
   - 获取和设置配置
   - 配置验证
   - 配置节获取

3. **性能显示测试**：
   - 颜色化功能
   - 时长格式化
   - 显示方法
   - 检测器设置

4. **集成测试**：
   - 跳句检测器与配置管理器的集成

### 4.3 测试输出

测试会显示详细的测试结果：

```
============================================================
运行单元测试
============================================================

test_duplicate_detection (__main__.TestImprovedSkipDetector) ... ok
test_partial_detection (__main__.TestImprovedSkipDetector) ... ok
test_similarity_detection (__main__.TestImprovedSkipDetector) ... ok
...

----------------------------------------------------------------------
Ran 20 tests in 0.123s

OK

============================================================
✓ 所有测试通过
============================================================
```

### 4.4 添加新测试

要添加新的测试用例，在 `test_improvements.py` 中添加：

```python
class TestYourFeature(unittest.TestCase):
    def test_your_feature(self):
        # 测试代码
        self.assertEqual(expected, actual)
```

## 五、使用建议

### 5.1 首次使用

1. **运行程序**：程序会自动创建默认配置文件
2. **查看配置**：检查 `config.json` 是否符合需求
3. **调整配置**：根据需要修改配置参数
4. **运行测试**：运行 `python test_improvements.py` 验证功能

### 5.2 日常使用

1. **监控统计**：关注实时显示的统计信息
2. **查看日志**：检查 `logs/` 目录下的日志文件
3. **调整参数**：根据使用情况调整配置参数

### 5.3 故障排除

1. **设备问题**：
   - 查看设备状态显示
   - 检查错误提示和建议
   - 查看设备日志

2. **跳句问题**：
   - 查看跳句统计信息
   - 检查跳句日志文件
   - 调整相似度阈值和时间窗口

3. **性能问题**：
   - 查看性能统计
   - 检查设备恢复次数
   - 调整配置参数

## 六、常见问题

### Q1: 配置文件在哪里？

A: 配置文件 `config.json` 位于项目根目录。

### Q2: 如何禁用性能监控？

A: 在 `config.json` 中设置 `"performance_monitor.enable": false`。

### Q3: 如何调整跳句检测的敏感度？

A: 修改 `config.json` 中的 `skip_detector.similarity_threshold`：
- 提高值（如 0.9）：更严格，只跳过非常相似的文本
- 降低值（如 0.7）：更宽松，跳过更多相似文本

### Q4: 测试失败怎么办？

A: 检查：
1. 所有依赖是否已安装
2. 测试文件是否完整
3. 查看测试输出的错误信息

### Q5: 如何查看详细的统计信息？

A: 查看 `logs/` 目录下的日志文件，包含详细的统计和错误信息。

## 七、更新日志

### v2.0.0 (当前版本)

- ✅ 添加配置管理系统
- ✅ 实现性能监控和实时显示
- ✅ 改进用户体验（友好错误提示、状态显示）
- ✅ 添加单元测试
- ✅ 集成所有新功能到主程序

### v1.0.0

- ✅ 基础语音识别功能
- ✅ 跳句检测功能
- ✅ 设备保护功能

